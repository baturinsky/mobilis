"use strict";(()=>{function Se(e,n){let t;switch(n){case 0:return t=[[0,-1],[1,0],[0,1],[-1,0]].map(([a,r])=>r*e+a),[t,t];case 4:return t=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]].map(([a,r])=>r*e+a),[t,t];case 1:return[[[0,-1],[1,0],[0,1],[-1,1],[-1,0],[-1,-1]],[[1,-1],[1,0],[1,1],[0,1],[-1,0],[0,-1]]].map(a=>a.map(([r,o])=>o*e+r));case 2:return t=[[1,-1],[2,0],[1,1],[-1,1],[-2,0],[-1,-1]].map(([a,r])=>r*e+a),[t,t];case 3:return t=[[0,-1],[1,0],[1,1],[0,1],[-1,0],[-1,-1]].map(([a,r])=>r*e+a),[t,t]}}function we(e,n,t){return e*(1-t)+n*t}function te(e,n,t){return t<e?e:t>n?n:t}function Ee(e,n,t){return n?[0,1,2,3].map(a=>we(e[a],n[a],t)):[0,0,0,0]}function Te(e){for(let n of[0,1,2])e[n]=te(0,255,e[n])}var X=6;function We(e,n){return((e[0]-n[0])**2+(e[1]-n[1])**2)**.5}function T(){let e=Math.sin(X)*1e4;return X=(X+Math.E)%1e8,e-Math.floor(e)}function J([e,n],t){return~~e+~~n*t}function Q(e){return e.getContext("2d")}function O(e,n){let t=document.createElement("canvas");t.width=e,t.height=n,t.style.width=`${t.width*devicePixelRatio}px`,t.style.height=`${t.height*devicePixelRatio}px`;let a=Q(t);return{canvas:t,ctx:a}}function K(e){let a=Q(e).getImageData(0,0,e.width,e.height).data,r=new Float32Array(a.length/4);for(let o=0;o<a.length;o++)r[o]=a[o*4+3]/255;return r}function _e(e,n,t=5e3,a=100,r=.01,o=!0){let{canvas:l,ctx:i}=O(e,n);if(o){let m=i.createRadialGradient(0,0,0,0,0,1);m.addColorStop(0,`rgba(255, 255, 255, ${r})`),m.addColorStop(1,"rgba(255, 255, 255, 0)"),i.fillStyle=m}else i.fillStyle=`rgba(255, 255, 255, ${r})`;for(let m=0;m<t;m++){let p=[...Array(3)].map(()=>T()),[s,d]=[p[0]*e,p[1]*n],M=Math.pow(p[2],2)*a;i.save(),i.translate(s,d),i.rotate(T()*Math.PI),i.scale(M*(.5+T()),M*(.5+T())),i.beginPath(),i.arc(0,0,1,0,Math.PI*2),i.fill(),i.restore()}return l}function Re(e,n){let{canvas:t,ctx:a}=O(e.width,e.height);return a.filter=n,a.drawImage(e,0,0),t}function Le(e,n=.5,t=1e3){if(!e)debugger;let a=e.length,r=[...Array(t)].map(()=>e[Math.floor(T()*a)]);return r=r.sort(),r[Math.floor(n*r.length)]}function je(e,n=1e3){let t=e.length,a=[...Array(n)].map(()=>e[Math.floor(T()*t)]),r=0;for(let o of a)o>r&&(r=o);return e.map(o=>o/r)}var _=({width:e,height:n},t,a,r,o)=>K(Re(_e(e,n,a,Math.sqrt(e*e+n*n)*r,o),`blur(${t}px)`));function Qe(e){let{width:n,height:t,seed:a,noiseSmoothness:r,tectonicSmoothness:o,noiseFactor:l,crustFactor:i,tectonicFactor:m,pangaea:p}=e;X=a;let s=n*t;console.time("noise");let d=_(e,r,3e3,.15,.03),M=_(e,o,2e3,.15,.03),R=_(e,o,2e3,.15,.03);console.timeEnd("noise"),console.time("main");let G=Le(M,.5),L=M.map((v,g)=>(.2/(Math.abs(G-v)+.1)-.95)*(R[g]-.2)*2),h=M.map((v,g)=>5+d[g]*l+M[g]*i+L[g]*m+-p*(Math.abs(g/s-.5)+Math.abs(g%n/n-.5)));console.timeEnd("main"),console.time("normalize");for(let v=4;v--;)for(let g=n;g<h.length;g++)for(let P of[-2,2,-n*2,n*2])h[g]+=((h[g+P]||0)-h[g])*.15;let S=je(h);return console.timeEnd("normalize"),{dryElevation:S,tectonic:L,p:e}}function se(e,n){return n??=Qe(e),qe(e,n)}function qe(e,n){let{width:t,height:a,averageTemperature:r,biomeScrambling:o,erosion:l,riversShown:i,randomiseHumidity:m,generatePhoto:p,shading:s,noiseSmoothness:d,seaRatio:M,flatness:R,noiseSeed:G,elevationCold:L}=e;X=G;let h=_(e,d,3e3,.15,.01),{dryElevation:S,tectonic:v}=n,g=t*a,P=Le(S,M),x=S.map((f,b)=>f<P?-Math.pow(1-f/P,.35):Math.pow((f-P)*(.5+v[b]*.5)/(1-P),1+2*R)),z=x.map((f,b)=>Math.cos((Math.abs(.5-b/g)*4+.85)*Math.PI)/(f<0?1:1+5*f*f));console.time("windSmoothing"),z=K(Re(Z(z,t,f=>[0,0,0,127*(f+1)]),"blur(3px)")).map(f=>f*2-1),console.timeEnd("windSmoothing");let N=Je({width:t,height:a,elevation:x,tectonic:v,erosion:l,riversShown:i}),F=Ve({width:t,elevation:x,wind:z,steps:400});m&&(F=F.map((f,b)=>Math.max(0,f+Math.sin(h[b]*50)/10-x[b]*.2)));let H=x.map((f,b)=>r+25-100*Math.abs(.5-b/g)/(.7+.6*F[b])-Math.max(0,f)*L);console.time("biome");let ge=H.map((f,b)=>{let E=x[b];if(E<-.4)return rt;if(E<-0)return nt;let u=1+o*Math.sin(h[b]*100),y=at[~~te(0,5,F[b]*4.5*u)][~~te(0,3,f*u/10+1)];return y==q&&x[b]>.5&&(y=Ce),y});console.timeEnd("biome");let xe=[...F],Me=[...F],ye;if(p){let b=function(E,u){if(E)for(let y of[0,1,2])f[y]=we(f[y],E[y],u)};console.time("photo");let f;ye=[...F].map((E,u)=>{let y=x[u];if(y<0)return[-(y**2)*1e3+100,-(y**2)*500+150,-(y**2)*300+150,255];{f=[H[u]*15-E*700,150-E*150,H[u]*8-E*500,255],Te(f);let Ae=(y+v[u])*2-1;Ae>0&&b([64,0,0,255],Math.min(1.5,Ae**2));let ee=(1+Math.sin((h[u]*3+v[u])*100))*(1+T());ee=(Math.sin(h[u]*100)+.5)*ee**2*.05,b([32,32,32],ee),xe[u]=0,N[u]&&(f=[0,100,150+50*N[u],255]);for(let U of[1,2,3])for(let B of[1,t,-1,-t,0])b(me[ge[u+B*U]],.05);if(H[u]<0&&b([500,500,500],-H[u]*.03),Te(f),s){let U=0;for(let Y=-2;Y<=2;Y++)for(let W=-2;W<=2;W++)U+=x[u+Y+t*W]*(Math.sign(Y)+Math.sign(W));let B=x[u+1+t]+x[u+t]+x[u+1]-y-x[u-t]-x[u-1]+U*.05;N[u]==0&&N[u+t]!=0&&(B-=.1),b([500,500,260],-B),Me[u]=B}return f}}),console.timeEnd("photo")}let ve={tectonic:v,dryElevation:S,elevation:x,noise:h,rivers:N,wind:z,temperature:H,humidity:F,biome:ge,folds:xe,photo:ye,shades:Me,p:e,poi:[]};return ot(ve),ve}function Fe(e,n,t=20){let a=e.length/n,r=Z(e,n,(i,m)=>[0,0,0,i<=0?100:0]),o=O(n,a),l=o.ctx;return l.beginPath(),l.lineWidth=n/8,l.rect(0,0,n,a),l.stroke(),l.filter=`blur(${t}px)`,l.filter="opacity(50%)",l.drawImage(r,0,0),{humidityImage:r,wetness:o.canvas}}function Ve({width:e,elevation:n,wind:t,steps:a}){console.time("humidity");let r=n.length/e,o=Math.sqrt(e*e+r*r),{humidityImage:l,wetness:i}=Fe(n,e,10),m=o/10;for(let s=0;s<a;s++){let d=[s%100/100*e,s%10/10*r],M=t[J(d,e)],R=[d[0]+M*.3*e/8,d[1]+Math.abs(M)*.5*r/12];i.getContext("2d")?.drawImage(i,d[0],d[1],m,m,R[0],R[1],m,m)}Q(l).filter="blur(30px)",Q(l).drawImage(i,0,0,e,r,0,0,e,r);let p=K(l);return console.timeEnd("humidity"),p}function Je({width:e,height:n,elevation:t,erosion:a,riversShown:r}){console.time("rivers");let{wetness:o}=Fe(t,e,100),l=K(o),i=t.map((s,d)=>1-s-l[d]*.3),m=new Float32Array(e*n),p=Se(e,4)[0];for(let s=0;s<a+r;s++){let d=s*12345%t.length,M=[],R=1e3;for(;t[d]>-.1&&R-- >0;){s>a&&(m[d]+=1);let G=i[d],L=0,h=1e6;for(let S of p)i[d+S]<=h&&(L=d+S,h=i[L]);if(h<G){let S=(i[d]-h)*.01;for(let v of[0,0,-1,1,-e,e])t[d+v]-=S,i[d+v]-=S}else i[d]=h+.05;M.push(d),d=L}}for(let s in t)t[s]>-.2&&t[s]<0&&(t[s]=t[s]>-.1?.01:t[s]*2+.2),t[s]>0&&(t[s]*=1+T()*.1);return console.timeEnd("rivers"),m}function Ke(e){let n=[];for(let t in e)n[t]=e[t];return n}function Ze(e){let n=parseInt(e,16);return[Math.floor(n/256)*16,Math.floor(n/16)%16*16,n%16*16,256]}var Ie=1,ne=2,q=3,re=4,ae=5,oe=6,k=7,ie=8,Pe=9,et=10,le=11,He=12,j=13,Ce=14,tt=15,nt=16,rt=17,at=[[q,He,re,Ie],[q,ae,ne,re],[le,ae,ne,ie],[le,j,ie,k],[oe,j,k,k],[oe,j,k,Pe]],$e=["unknown","desert","grassland","tundra","savanna","shrubland","taiga","tropical forest","temperate forest","rain forest","swamp","snow","steppe","coniferous forest","mountain shrubland","beach","coast","ocean"],V=" ,\u{1F42A},\u{1F402},\u{1F43B}\u200D\u2744\uFE0F,\u{1F992},\u{1F98A},\u{1F43A},\u{1F406},\u{1F98C},\u{1F418},\u{1F40A},\u{1F43E},\u{1F40E},\u{1F98C},\u{1F40F},\u{1F980},\u{1F420},\u{1F40B},".split(","),C=" ,\u{1F335},\u{1F33B},\u2744\uFE0F,\u{1F33F},\u{1F342},\u{1F332},\u{1F334},\u{1F333},\u{1F334},\u{1F331},\u26C4,\u{1F33E},\u{1F332},\u26F0\uFE0F,\u{1F3D6}\uFE0F,\u{1F3DE}\uFE0F,\u{1F30A}".split(",");console.log(C,C.map(e=>e.length));var me=Ke({[Ie]:"fa0",[ne]:"4f4",[re]:"ff8",[q]:"cca",[ae]:"ad4",[oe]:"064",[k]:"0a0",[ie]:"060",[Pe]:"084",[et]:"880",[le]:"fff",[He]:"caa",[j]:"0a6",[Ce]:"884",[tt]:"ff0"}).map(Ze);function Z(e,n,t,a){let r=e.length/n,{canvas:o,ctx:l}=O(n,r),i=l.createImageData(n,r);if(!i.data||!e)debugger;for(let m=0;m<e.length;m++){let p=0,s=t?t(e[m],m)??0:[0,0,0,e[m]];i.data.set(s,m*4)}return l.putImageData(i,0,0),o}function pe({elevation:e,rivers:n},t){return n??=[],(a,r)=>{let o=e[r];return a>0?[250-o*300,200-o*300,n[r]*100,255]:[0,o*60+60,o*80+100,255]}}function De(e,n,t){let{canvas:a,ctx:r}=O(n,t);return r.drawImage(e,0,0,e.width,e.height,0,0,n,t),a}function ot(e){let n=[];for(let r=400;r--;){let o=[r%400/400*e.p.width+T()*40,r%20/20*e.p.height+T()*40],l=J(o,e.p.width),i=e.biome[l],m=r%2?V[i]:C[i],p=1+T(),s={at:o,icon:m,size:p};n.push(s)}let t=[...V,...C],a=[];for(let r of t){let o=n.filter(l=>l.icon==r);for(let l of[...o])for(let i of[...o])l!=i&&i.size&&l.size&&We(l.at,i.at)<50&&(l.size+=i.size,i.size=0);a.push(...o.filter(l=>l.size))}console.log("fp",a),e.poi=a}var Ne=[["seed","number"],["noiseSeed","number"],["width","number"],["height","number"],["noiseSmoothness","range",{max:10,step:.5}],["tectonicSmoothness","range",{max:10,step:.5}],["noiseFactor","range",{min:-5,max:20,step:.5}],["crustFactor","range",{min:-5,max:20,step:.5}],["tectonicFactor","range",{min:-1,max:10,step:.1}],["pangaea","range",{min:-5,max:5}],["seaRatio","range",{tip:"Sea percentage"}],["flatness","range"],["randomiseHumidity","checkbox"],["averageTemperature","range",{min:-30,max:50,step:1}],["elevationCold","range",{min:0,max:300,step:1}],["erosion","range",{max:1e5}],["riversShown","range",{max:1e3}],["biomeScrambling","range"],["squareGrid","checkbox"],["gameMapScale","range",{min:0,max:4,step:1}],["gameMapRivers","range",{max:5e4,step:1e3}],["discreteHeights","range",{max:40,step:1}]];var Be={mapMode:0,seed:1,width:640,height:640,scale:1,noiseFactor:10,crustFactor:6,tectonicFactor:3,noiseSmoothness:2,tectonicSmoothness:5,pangaea:0,seaRatio:.55,flatness:.5,randomiseHumidity:0,averageTemperature:15,erosion:5e4,riversShown:400,biomeScrambling:0,terrainTypeColoring:0,discreteHeights:0,hillRatio:.12,mountainRatio:.04,gameMapRivers:15e3,gameMapScale:2,generatePhoto:1,squareGrid:0},c={};function it(){if(document.location.hash){c={};let e=document.location.hash.substr(1).split("&").map(n=>n.split("="));console.log(e);for(let n of e)c[n[0]]=n[1]=="false"?!1:n[1]=="true"?!0:Number(n[1]);console.log(c)}(!c||!c.width)&&(c=JSON.parse(localStorage.mapGenSettings)),(!c||!c.width)&&(c={...Be}),ke(),fe()}window.onload=it;window.resetSettings=()=>{};function fe(){for(let[e,n]of Ne){if(n=="tip")continue;let t=document.getElementById(e);c[e]=t.type=="checkbox"?t.checked?1:0:Number(t.value);let a=document.getElementById(e+"_value");a&&(a.innerText=String(c[e]).substr(0,8))}Xe(),mt(c)}window.applySettings=fe;document.body.addEventListener("mousedown",e=>{switch(e.target?.id){case"resetSettings":c={...Be},ke(),fe();return}});function lt(e,n,t,a){let r={};for(let o of a??Object.keys(e)){r[o]=new Float32Array(e[o].length);let l=e[o],i=n[o];if(o=="photo"||o=="biome")for(let m in l)r[o][m]=Ee(l[m],i[m],t);else for(let m in l)r[o][m]=l[m]*(1-t)+i[m]*t}return r}blendMaps.onchange=e=>{let n=Number(blendMaps.value);if($.length>=2){console.time("blend");let t=lt($[$.length-2],$[$.length-1],n,["dryElevation","tectonic"]);console.timeEnd("blend"),console.time("blendGen");let a=se(Ue,t);console.timeEnd("blendGen"),ze(a)}};var ce={};function ke(){let e=document.getElementById("form");e.innerHTML="";for(let n of Ne){let[t,a,r]=n;switch(r=r||{},ce[t]=r.tip,a){case"tip":e.innerHTML+=`<div class="tip">${t}</div>`;break;case"checkbox":e.innerHTML+=`<div>${t}</div><input class="checkbox" type="checkbox" id="${t}" ${c[t]?"checked":""} />`;break;case"number":e.innerHTML+=`<div>${t}</div><input class="number" type="number" id="${t}" value="${c[t]}" />`;break;case"range":let o=r.min||0,l=r.max||1,i=r.step||(l-o)/100;e.innerHTML+=`<div>${t}</div><input class="range" type="range" id="${t}" min="${o}" max="${l}" step="${i}" value="${c[t]}"/>
        <div id="${t}_value"></div>
        `;break}}}function Xe(){document.location.hash=Object.keys(c).map(e=>`${e}=${c[e]}`).join("&"),localStorage.mapGenSettings=JSON.stringify(c)}var ue=[],Oe,be;function I(e,n,t,a=1/4,r){let o=Z(e,c.width,t,r),l=De(o,o.width*a,o.height*a),i=l.getContext("2d");i.font="14px Verdana",i.fillStyle="#fff",i.strokeText(n,5,15),i.fillText(n,4,14),miniMaps.appendChild(l);let m=ue.length;return m==c.mapMode&&(main.appendChild(o),main.style.width=`${c.width*devicePixelRatio}px`,main.style.height=`${c.height*devicePixelRatio}px`,be=o),l.id="mini_"+m,ue.push(o),Oe.push(l),l.onclick=()=>{c.mapMode=m,Xe(),main.setHTMLUnsafe(""),main.appendChild(o)},o}var D,$=[],w=[0,0],Ge,de;function st(e){let n=J(e,c.width);tooltip.style.left=`${Math.min(window.innerWidth-300,de[0]+20)}`,tooltip.style.top=`${Math.min(window.innerHeight-300,de[1]-40)}`,tooltip.style.display="grid",tooltip.innerHTML=Object.keys(D).map(t=>{let a=D[t][n];return`<div>${t}</div><div>${t=="photo"?a?.map(r=>~~r):t=="biome"?a+" "+C[a]+V[a]+$e[a]?.toUpperCase():~~(a*1e6)/1e6}</div>`}).join("")}document.onmousemove=e=>{let n=[e.movementX,e.movementY];de=[e.screenX,e.screenY],e.target==be&&e.buttons&&(w[0]+=n[0]*devicePixelRatio,w[1]+=n[1]*devicePixelRatio,he());let t=e.target,a=t.tagName=="CANVAS",r=t.id;a?(Ge=[e.offsetX/t.width*c.width/devicePixelRatio,e.offsetY/t.height*c.height/devicePixelRatio],st(Ge)):ce[r]?tooltip.innerHTML=ce[r]:tooltip.style.display="none"};var A=1;main.onwheel=e=>{let n=A;A+=(e.deltaY>0?-1:1)*1/8,A=A<0?0:A,console.log(A,w),w[0]=(w[0]-400)*2**(A-n)+400,w[1]=(w[1]-400)*2**(A-n)+400,e.preventDefault(),e.stopPropagation(),he()};function ze(e){let{elevation:n,dryElevation:t,tectonic:a,rivers:r,wind:o,temperature:l,humidity:i,biome:m}=e;if(console.time("draw"),main.setHTMLUnsafe(""),miniMaps.setHTMLUnsafe(""),ue=[],Oe=[],I(n,"elevation",pe({elevation:n,rivers:r},c)),I(t,"dryElevation",pe({elevation:n.map(p=>p/3+.3),rivers:void 0},c)),I(a,"tectonics",(p,s)=>[0,0,0,p*255]),I(l,"temperature",(p,s)=>[p*5+100,255-Math.abs(p-5)*10,155-p*5,255]),I(o,"wind",(p,s)=>[p*100,0,-p*100,255]),I(i,"humidity",(p,s)=>r[s]&&n[s]>0?[0,0,0,255]:s%c.width<20?[o[s]*100,0,-o[s]*100,255]:n[s]<0?[0,0,0,255]:[300-p*1e3,n[s]*200+50,p*350-150,255]),I(m,"biome",(p,s)=>n[s]<0||r[s]?[0,40,80,255]:me[p]),c.generatePhoto){I(e.photo,"photo",p=>p,void 0,p=>Math.max(1,~~(n[p]*20)*2));for(let p of e.poi){let s=document.createElement("div");s.classList.add("poi"),s.innerHTML=p.icon,p.div=s,main.appendChild(s)}}console.timeEnd("draw"),he()}var Ue;function he(){be.style.transform=`translate(${w[0]}px, ${w[1]}px) scale(${2**A})`;for(let e of D.poi){let n=e.div;n&&(n.style.left=`${e.at[0]*devicePixelRatio*2**A+w[0]-8}px`,n.style.top=`${e.at[1]*devicePixelRatio*2**A+w[1]-8}px`,n.style.fontSize=`${e.size**.5*8*2**A}px`)}}function mt(e){Ue=e,console.time("generation total"),D=se(e),$.push(D),ze(D),console.timeEnd("generation total")}})();
